---
marp: true
theme: default
size: 16:9
header: ""

page_number: true
paginate: true
---

Programming Boot Camp Learning Phase #3

# Bubble Basic #2

2024/11/23

---

## 事前準備

- 本日は前回作成したペットの健康管理アプリに、デザインやロジックを追加していきます
- その後、さらに API 連携やチーム開発といった応用についてもお話していきます
- 本日の講義用に多少手を加えていますので、開始時点をそろえるため、こちら側で用意したアプリケーションを複製したものを利用してもらいます
- 複製したアプリケーションを配布しますので、`@imahashi` 宛てに、Bubble のアカウントを作成したメールアドレスを伝えてください。
- また、動作確認用に実際にペットを 5 件くらい登録しておいてください。
  ![w:500px](images/2023-11-09-04-36-17.png)

---

## 今日やること

- 前回のおさらい
- デザインを作りこむ
- ロジックを作りこむ
- 外部システムと連携する
- チームで開発する

---

## 前々回のおさらい

- [Bubble](https://bubble.io/) はビジュアルプログラミングツールとうたっており、画面からポチポチと操作して、見た目や動きをプログラミングできるツールです。
- Web アプリケーション前提であり、ディスプレイサイズにあわせた対応をいれスマホや PC に対応させます。

- 前回お休みの方はこちらの資料でキャッチアップしましょう
  - https://github.com/GuildWorks/isct-pbc-2024/tree/main/docs/learning-phase-1/Bubble1/pdf

---

## 前々回のおさらい

ペット管理アプリケーションのペットの登録、一覧、詳細、体重記録の画面を
作りながら、Bubble の基本である、Design/Workflow/Data の使い方を学びました。

![w:800](images/2024-11-20-07-28-28.png)

---

## 今日やること

まずは前回までのアプリケーションに対して、デザインやロジックをさらに作り込んでいきます

---

## 最終的にはこんな感じになります

### ペットリスト（PC/スマホの表示切り替え）

![w:700](images/2024-11-22-05-06-54.png)![w:200](images/2024-11-22-05-07-20.png)

---

### ペット詳細（ロジックを使ったデータ加工表示）

![w:300](images/2024-11-22-05-08-34.png)

---

### アドバイザー用ペットリスト（ロジックを使った権限制御）

![w:400](images/2024-11-22-05-14-07.png)

---

### AI ペットアドバイザー（ChatGPT との連携）

![w:300](images/2024-11-22-05-12-12.png)

---

### 動画検索（Youtube との連携）

![w:300](images/2024-11-22-05-19-05.png)

---

### Google ログイン（Google との連携）

![w:500](images/2024-11-22-05-20-38.png)

---

### では、さっそくはじめていきましょう。

### まずはデザインを作りこんでいきます

---

# モバイルファーストでいこう

なお、今回はスマホの画面サイズをメインにしてつくっていきます。

モバイル端末に体験やデザインを最適化するアプローチを「モバイルファースト」と言います。

インターネットサービスの利用においてスマートフォンが PC を超えており、サービスや事業フェーズによっては、スマートフォンを主としたモバイル端末での利用を優先して、進めることも多くなっています。

---

# モバイルファーストってどんなことをする？

- レスポンシブデザイン：スマホ向けのデザインを基に作り、PC やタブレットでの表示を調整する。
- タッチ操作の優先：マウスよりも指での操作が中心となるため、ボタンやリンクを押しやすくする。
- 高速ロード：モバイルデータ通信の速度や制限を考慮して軽量化を重視する。　など

---

# Bubble でモバイルファーストはどうやる？

最も簡単にできる方法としては、開発時からページの幅をスマートフォンに合わせた幅にして開発を進めてあげることです。試して見ましょう。

---

# まずは、空のページを立ち上げてください。

- 本日みなさんに配布したアプリを開く
- 画面左上の b ロゴの右側の `Page:xxxxx`となっている部分をクリック
- `Add a new page...`をクリック
- 適当な名前をつけて、`Create`をクリック。これで空のページができます。

---

# 初期のまま、単純に作ってしまうと PC に最適化される

- 前の会では意識しなかったかもしれませんが、この時点で画面幅は PC よりの幅になっていますね。
- このままの画面幅で単純にアプリケーションをつくっていくとスマートフォンでの表示には適さないアプリケーションになります。
- 試しに、大きめの画像を横に並べて配置してみましょう。

![w:600](images/2024-11-20-08-20-52.png)

---

# スマートフォンの画面幅では画像が切れてしまう

プレビューしてみましょう。
PC ではうまく表示出来ていると思いますが、スマートフォンだと見切れてしまいます。
※PC のウィンドウサイズを狭めてみるか、デモ表示の際の URL をスマートフォンに送ってスマートフォンで見てみてください。

![w:700](images/2024-11-20-08-23-46.png)　![w:200](images/2024-11-20-08-24-40.png)

---

# スマートフォンの画面幅を意識して開発しよう

そこでスマートフォンの画面幅を意識して広がりすぎないように作るのが最も単純な対応になりますが、そのままでは開発しにくいので、開発時の画面幅をスマートフォンの画面幅に設定してしまいます。

---

# スマートフォンの画面幅に設定する

- 先ほど作った画面の Design ビューを開き（開いているはずです）
- 画面自体を選択するために、画面の外側の灰色の部分をクリックします
- `Layout`タブを開きます
- `Width`に`400`、`Height`に`1200`を指定します。

![bg right w:600px](images/2024-11-20-08-38-58.png)

---

# スマートフォンの画面幅にあわせてレイアウトを整える

- 画像をその幅でいい感じにならぶように修正しましょう。
- 中央揃えでキレイに並べたいなら、Shift を押しながら全て選択し、右クリック（もしくはダブルタップ）して、`Center horizontally`を選択するとすべて中央そろえにしてくれます。

こんな感じですね。

![w:600](images/2024-11-20-08-38-03.png)

---

# こんな感じになります

スマートフォンに最適化された表示になっています。
PC だと横幅がもったいないですが、PC でも表示はできていて利用可能です。モバイルを優先した最も単純かつ強力な対応で、スマートフォンを主としてよいフェーズでは強力です。

![w:800](images/2024-11-20-08-41-09.png)　![w:220](images/2024-11-20-08-41-39.png)

---

# 様々なディスプレイサイズへの対応について

なお、一概にモバイルといっても、ディスプレイサイズは様々です。

スマートフォンもあればタブレットもあります。また、単にスマートフォンといっても、iPhone Pro MAX のような大きな画面をもつスマートフォンがあったり Galaxy Fold のような広く広げられるものもあります。

ディスプレイサイズは様々なので、あらゆるディスプレイサイズに対して、もっと細やかに対応させていくことができます。

そのための方法がレスポンシブウェブデザインという方法になります。こちらは後ほどふれていくこととします。

---

# モバイルファーストでいこう

今回、みなさんに配布している Bubble アプリは、前々回、京極がレクチャーした内容を先ほどのやり方で画面幅 400 でレイアウトしなおしたものになります。本日はこちらをつかっています。

では戻って、デザインの作り込みについて話していきます。

---

### デザインの作り込みでやること

- ディスプレイサイズに合わせた画面をつくろう
  - レスポンシブウェブデザインという手法を使って、ディスプレイサイズに見た目を制御します
- Style を使ってみよう
  - Style を編集・追加したり、個別にスタイルをあてます

---

## ディスプレイサイズに合わせた画面をつくろう

---

## ディスプレイサイズに合わせた画面をつくろう

- Web アプリケーションは PC やタブレット、スマートフォンといった様々な端末で利用されます。
- 端末毎にディスプレイサイズが違うのですが、それらに対応する手法としてレスポンシブウェブデザインというデザイン手法があります
- 画面サイズに応じて、要素が伸びる／縮む、折り返す／折り返さない、表示する／表示しないといった見た目の切り替えが柔軟に行われる手法になります。
- 実現方法として、固定した配置やサイズを指定するのではなく、配置やサイズを決めるためのルールを指定します。
- Bubble は初期設定では、固定の配置やサイズが指定されるようになっていますが、各種ルールを指定することもできるようになっています。

---

## よく使うルール

Bubble でレスポンシブデザインを実現するために、よく使うルールとして以下のようなものがあります。

1. 親要素内の配置ルール
2. 要素のサイズ決定ルール
3. 表示の有無ルール

これらのルールを組み合わせて、レスポンシブな画面デザインを実現します。
なお、これらのルールは Bubble に限らず、Web アプリケーション全般に通じる考え方でもあります。

後ほど、一緒に画面に組み込んでいきますが、難しい考え方もあるので、まずは概要を説明していきます。

---

## ルール 1：親要素内の配置ルール

親要素の中でどう配置するかという、ルール指定になります。

リピーティンググループなどのグループやページ全体など個々の要素を囲むような親要素を Bubble では Container と呼ばれています。
Container では中に含む子要素の配置ルールを指定できます。

![w:600](images/2022-11-25-09-18-25.png)

---

子要素の配置ルールとしては以下の 4 つがあります。

- Fixed：配置場所を固定で指定する
- Aligng to parent：親要素に対する相対位置を指定する
- Row：行方向（水平方向）に並べる
- Column：列方向（垂直方向）に並べる

順に説明していきます。

---

## Fixed：配置場所を固定で指定する

配置場所を固定で指定するルールです。配置場所をピクセル単位で指定します。
Bubble で親要素を置いた場合の初期設定となります。

固定で指定しているため、画面幅を変更しても指定した位置から変更されません。下の例では、画面の外にはみ出してしまっています。

![w:400](images/2022-11-25-07-40-30.png)→![w:120](images/2022-11-25-07-41-48.png)

---

## Aligng to parent：親要素に対する相対位置を指定する

親要素に対する相対位置を指定するルールです.
Bubble では、9 つのエリアから配置場所を指定できる。
![](images/2022-11-25-07-46-27.png)

画面幅を変更したら、相対位置を維持して動く。下の例では、画面幅を狭めると、左上・中央・右下という相対位置を維持して動いている。
![w:500](images/2022-11-25-07-48-50.png)→![w:140](images/2022-11-25-07-50-08.png)

---

## Row：行方向（水平方向）に並べる

行方向（水平方向）に並べるルールになります。行は自動で折り返します。
下の例では、画面幅を狭めると、行が折り返していき、結果として縦に並んでいます。
![w:300](images/2022-11-25-07-56-45.png)→![w:140](images/2022-11-25-07-57-06.png)

---

## Row：行の中での水平方向（左右）の配置を指定できる

要素ごとに行の中での垂直方向の配置を指定できます。
![w:600](images/2022-11-25-08-14-01.png)
![w:300](images/2022-11-25-08-14-33.png)　(Left-aligned)
![w:300](images/2022-11-25-08-14-54.png)　(Centered)
![w:300](images/2022-11-25-08-15-15.png)　(Right-aligned)
![w:300](images/2022-11-25-08-16-46.png)　(Space-around)
![w:300](images/2022-11-25-08-17-11.png)　(Space-between)

---

## Row：行の中での垂直方向（上下）の配置を指定できる

行の中での垂直方向の配置を指定できる。
※これは親要素ではなく、子要素に対して指定するものになります。

![w:600](images/2022-11-25-08-10-28.png)
![w:300](images/2022-11-25-08-07-34.png)![w:300](images/2022-11-25-08-08-19.png)![w:300](images/2022-11-25-08-08-49.png)

---

## Column：列方向（垂直方向）に並べる

列方向（垂直方向）に並べる.
下の例は左右中央寄せで縦に並べており、画面幅を小さくしても中央寄せを維持したまま縦に並んでいる。
![w:450](images/2022-11-25-08-29-13.png)→![w:130](images/2022-11-25-08-29-31.png)

Row と同様に水平、垂直の配置を指定できる。（水平・垂直で指定できる内容は反対）

---

## ルール 1(おさらい)：親要素内の配置ルール

親要素の中でどう配置するかという、ルール指定になります。
子要素の配置ルールとしては以下の 4 つがあります。

- Fixed：配置場所を固定で指定する
- Aligng to parent：親要素に対する相対位置を指定する
- Row：行方向（水平方向）に並べる
- Column：列方向（垂直方向）に並べる

---

## ルール 2：要素のサイズ決定ルール

画面幅によって、大きくなったり小さくなったりできるように、固定サイズを指定のではなく、サイズを決めるためのルールを指定します。主に以下の二つのいずれかを利用します。

- 親要素の大きさに対するパーセンテージを指定する
- 伸び縮みした場合の最大・最小サイズを指定する
  - ※最大最小は指定せずに、無制限にすることも可能

---

## パーセント指定

下の例は、画面に対して幅が 80%になるように指定しています。画面幅を小さくすると、80%の割合を維持しながら画像サイズも小さくなります。

![w:600](images/2022-11-25-08-43-41.png)→![w:180](images/2022-11-25-08-44-19.png)

---

下の例は、幅を最大 800px、最小 300px に指定しています。
300px から 800px の間で伸縮しますが、画面を広げきっても 800px 以上は大きくならないですし、逆に画面を狭めても 300px 以下にはなりません。

![w:600](images/2022-11-25-08-49-25.png)→![w:150](images/2022-11-25-08-50-59.png)

---

## ルール 3：表示の有無ルール

画面幅の下限や上限を指定して、画面内の要素の表示・非表示を切り替えることができます。

下の例は、画面幅が 992px 以下になった場合に画像を表示しないという指定をしています。
![w:600](images/2022-11-25-09-02-33.png)→![w:170](images/2022-11-25-09-03-22.png)

画面が大きい場合だけ情報を多く表示したいと言った場合によく使います。

---

## よく使うルール(おさらい)

Bubble でレスポンシブデザインを実現するために、よく使うルールとして以下のようなものがあります。

1. 親要素内の配置ルール
2. 要素のサイズ決定ルール
3. 表示の有無ルール

では、実際に使ってみましょう。

---

## （再確認）事前準備

- 本日は前回作成したペットの健康管理アプリに、デザインやロジックを追加していきます
- 本日の講義用に多少手を加えていますので、開始時点をそろえるため、こちら側で用意したアプリケーションを複製したものを利用してもらいます。
- 複製したアプリケーションを配布しますので、`@imahashi` 宛てに、Bubble のアカウントを作成したメールアドレスを伝えてください。
- また、動作確認用に実際にペットを 5 件くらい登録しておいてください。

![w:500px](images/2023-11-09-04-36-17.png)

---

## ペット一覧ページにレスポンシブデザインを適用します

ペット一覧ページにレスポンシブデザインを適用します。

以下のルールを利用します。

1. 親要素内の配置ルール
2. 要素のサイズ決定ルール

またサイズの指定やリピーティンググループ特有のレスポンシブ対応用の設定も組み合わせていきます。

---

## 完成イメージ

対応すると、画面幅に列数が柔軟に変わり、すべてのペットが一覧で見れます。
![w:200](images/2024-11-20-23-22-09.png)→![w:650](images/2024-11-22-05-49-45.png)

---

まずは、親要素となるページの`Container layout`を変更しましょう。
今回は、`Column`を指定します。

- `pet_list`の画面を開く
- ページの空白部分をダブルクリックして、ページ自体の設定ウィンドウを開く
- 設定ウィンドウの Layout タブを指定する
- `Container layout`を`Column`に変更する

![bg right w:400](images/2022-11-25-13-04-53.png)

---

そうすると、勝手に画面内の要素が縦に詰めて並ぶようになりましたね。
`Column`で設定された親要素の直下の子要素は列方向（垂直方向）に勝手に整列されるのです。この並びを基本として、整えていきます。
![bg right w:400](images/2024-11-20-23-23-38.png)

---

続いて、リピーティンググループに対して設定をいれていきます。

- リピーティンググループ`pet list`の設定ウィンドウを開き、`Layout`タブに移動する
- 以下の設定をいれる
  - Horizontal alignment:`centered`

![w:600](images/2022-11-25-13-19-40.png)

ペット一覧ページ直下の要素が列方向に並ぶようにしていますが、その際にこのリピーティンググループは左右中央寄せに整列されるようになります。

---

さらに、以下の設定をいれる

- Make this element fixed-widtht: チェックなし
- Min widht: 300px
- Max width: 1010px

このリピーティンググループの幅は固定にせず、親要素（ここでは画面自体）の幅に応じて柔軟に伸縮します。ただし、極端なサイズだと見えにくいので、最小幅は 300px とし最大幅は 1010px までとしています。

![bg right w:400](images/2024-11-20-23-28-10.png)

---

以下の設定をいれる

- Make this element fixed-height: チェックなし
- Min height: 指定なし
- Max height: 指定なし(inf)　※おそらく infinity の略
- Fit height to content: チェック

このリピーティンググループの高さは固定せず、中身に合わせてどこまでも伸縮するという設定です。

![bg right w:400](images/2022-11-25-13-25-28.png)

---

次はリピーティンググループの設定ウィンドウの`Appearance`タブに移ってください。
以下を設定していきます。

- Set fixed number of rows: チェックなし
- Min height of row: 200px
- Set fixed number of columns: チェックなし
- Min widht of column: 250px

列数と行数は固定せず、行と列の最低幅を指定するようにしています。これによって、行数や列数が最低幅を維持しながら、表の大きさによって柔軟に切り替えられます。

---

では、プレビューを表示してみましょう。

まだ不細工ですが、画面の幅・表の幅に合わせて、列数・行数が変動するようになりました。
![w:600](images/2024-11-20-23-31-37.png)　![w:150](images/2024-11-20-23-32-11.png)

でも、セルの中で左によってしまっていたり、幅を小さくしていく際に意図しない余白ができてしまっていたりしますね。修正していきましょう。

---

またリピーティンググループの設定ウィンドウの`Layout`タブに移ってください。
以下を設定します。

- Cell's container layout: Align to parent

親要素（ここではリピーティンググループの一つ一つのセル）に対して、相対位置で要素を配置できるようになります。

![bg right w:400](images/2022-11-25-18-46-01.png)

---

次にセルの中身の要素のレイアウトをしていきます。

要素が重なっていて選びにくいので、画面左の`Elements tree`から指定します。

- Design メニューの`UI Builder`の最上部に`Elements tree`という部分があります。
- `Only show hideable`のチェックがついていたら外してください。
- ※`pet list`しか表示されていない場合は、`+`をクリックしてツリーを開いてください。

![bg right w:400](images/2022-11-25-18-51-06.png)

---

では、`pet list image`から順に設定していきます。

- `Elements tree`の`pet list image`をクリックして設定ウィンドウを開く
- `Layout`タブ内で右の画像と同様に設定してください。

セル内の真ん中に配置し、縦横比を 4:5 に保ったままセル内いっぱいまで大きく表示する、という設定になります。

![bg right w:400](images/2022-11-25-19-00-50.png)

---

次は、`Shape A`の`Layout`に右の画像と同様の設定をいれます。

セル内の下部に配置し、高さ 45px を保ったまま左右いっぱいまで大きく表示する、という設定になります。

![bg right w:400](images/2022-11-25-19-05-28.png)

---

次は、`pet list name`の`Layout`に右の画像と同様の設定をいれます。

`Shape A`と同じ内容ですね。

![bg right w:400](images/2022-11-25-19-08-56.png)

---

プレビューします。

惜しいですね。あとはヘッダーの位置や余白が気になります。

![w:800](images/2024-11-20-23-39-56.png)![w:200](images/2024-11-20-23-40-44.png)

---

ヘッダーの設定ウィンドウを開き、`Layout`に右の設定を入れます。

ページ内で列方向に並べられる際に、中央揃えで表示する。横幅は固定せずページ幅に応じて、最大 1080px まで伸びる。下側に 20px の余白をとる。という設定です。

![bg right w:350](images/2022-11-25-19-29-48.png)

---

つづいて、Register リンクの設定ウィンドウを開き、`Layout`に右の設定を入れます。

![bg right w:350](images/2024-11-21-00-12-15.png)

---

## Magin と Padding について

Margin という言葉がはじめて出てきましたので、説明します。
余白を表す言葉に、Margin と Padding というものがあり、それぞれ以下を意味します。

- Margin：要素の境界の外側の余白
- Padding：要素の境界の内側の余白

![](images/2022-11-25-19-32-28.png)

境界線の内と外ととで、余白を使い分けたい時に意識してみてください。

---

ついでに、リピーティンググループにも余白をいれておきます。

リピーティンググループの`Layout`タブで以下を設定してください。

上下の余白に 10px、左右の余白に 50px をとるという設定になります。

![bg right w:300](images/2022-11-25-19-38-36.png)

---

では、プレビューしましょう。

![w:800](images/2024-11-21-00-13-05.png)![w:250](images/2024-11-21-00-13-39.png)

やったー。

---

### <Excercise>

## ペット詳細画面にレスポンシブデザインを適用しよう

ペット詳細画面がせっかくの PC 画面の広さを活かせないようになっているので、レスポンシブ対応しましょう。

---

## ステップ 1：画面幅に応じて、伸縮させる　※難易度：中

ヒント

- 親要素内の配置ルールを Column を利用して縦にならべる。
- 各要素を画面幅に応じて伸縮させる。

---

## ステップ 2：画面幅に応じて、段組を変える　※難易度：高

ヒント

- 子どもの要素を 2 つほどのかたまりにグルーピングする。
- グループを画面幅に応じて、縦にならべたり横にならべたりと、段組を切り替えるようにする。（段組を切り替えたいグループを、さらにグループで囲って配置ルールを Row にする。）

---

## よく使うルール(おさらい)

Bubble でレスポンシブデザインを実現するために、よく使うルールとして以下のようなものがあります。

1. 親要素内の配置ルール
2. 要素のサイズ決定ルール
3. 表示の有無ルール

これらを組み合わせて、レスポンシブデザインを適用しましょう。

---

## Style を使ってみよう

---

## Style を使ってみよう

- これまでは Bubble が標準で用意してくれていたスタイルを利用してきました
- 実際のプロダクトでは、プロダクトにあったデザインコンセプトを描き適用していきます
- ここからスタイルを変更する方法を説明します

---

## Style の適用方法には大きく 3 つあります

- 既存のスタイルを編集する
- 個別でスタイルを適用する
- 新しいスタイルを追加する

順にやっていきましょう

---

# 既存のスタイルを編集する

まずは、既存のスタイルを変更して、ボタンやリンクの色を変更したいと思います。

![w:800](images/2024-11-21-07-57-18.png)

---

## Style variables をつかってみよう

Bubble では、基本となる色やフォントが`Style variables`として設定されています。

左メニューの`Styles` > 画面上部のタブで`Style varilables`に移動してみてください。ここで指定された色は、スタイルの作成時や編集時に利用することができます。例えば、Primary という色設定は、基調色を意味し、Primary ボタンなどで利用されています。

![w:800](images/2024-11-21-07-54-26.png)

---

`Style variables`の`Primary`の設定を変更すると利用されているすべての箇所に変更が適用されています。

- 左メニューの`Styles` > 画面上部のタブで`Style varilables`と選択
- Primary を変更する。（私は暗い目の赤にしたいので、`#D62755`で指定します。）

![w:600](images/2024-11-21-07-56-12.png)

---

Primary ボタンのスタイルを確認すると、変更されていますね。

![w:800](images/2022-11-26-00-26-56.png)

---

## プレビュー

画面をプレビューしてみましょう。
ログイン／ログアウトボタンなど、基調となっていたボタンやリンクの色が変っています。

![w:600](images/2024-11-21-07-57-42.png)

---

## Style variables の使いどころ

このように、`Style variables`を編集することで、標準の基調カラーを一括で変更できます。また、新たにスタイルを作成・編集する際も自分でルールを決めて`Style variables`を利用しておくことで、あとから一括で変更するなどメンテナンスが楽になります。

---

## 次に、個別でスタイルを指定してみましょう

ヘッダーロゴを基調色にあわせつつ、フォントももう少しかわいらしい感じにしたいと思います。

![w:900](images/2024-11-21-08-09-20.png)

---

b ロゴ右のメニューを開いて、header を選びます

![w:900](images/2024-11-21-07-59-08.png)

---

- ロゴをダブルクリックして、設定を開く
- 設定ウィンドウの`Style`の部分に移動する
- プルダウンの右下あたりの`Detach style`をクリック
  - 定義された Style を適用するのではなく、個別で指定できるようになります

![bg right w:500](images/2022-11-26-00-34-55.png)

---

好きなスタイルを指定しましょう

- 私はフォントカラーは、`Style variables`で指定した Primary カラー
- フォントは`Noto Sans Mono`が気に入ったので、それを指定します。
- サイズは`32px`くらいにしておきます。
- フォントを変えると、ロゴが見切れたりすることがあるので、幅は適宜調整してください

![bg right w:500](images/2024-11-21-08-06-21.png)

---

## プレビューしましょう

変わりましたね。

![w:800](images/2024-11-21-08-07-47.png)

---

## 次は、新しいスタイルを追加してみましょう

ラベルが大きすぎて気になるので、ラベル用のスタイルを作っちゃおうと思います。

![bg right w:300](images/2024-11-21-08-29-31.png)

---

まずは個別にスタイルを指定します。

- pet_detail を開いて、`Image`テキストをダブルクリックして、設定を開く
- `Style`のプルダウン右下の`Detach style`をクリック

![bg right w:600](images/2024-11-21-08-11-18.png)

---

以下の設定にします

- フォントは`Barlow`
- フォントウェイトは`600`
- フォントサイズは`14`
- `Center the text vertically`にチェック

![bg right w:400](images/2024-11-21-08-12-51.png)

---

続いて、指定した個別のスタイルを共通のスタイルとして定義します

- そのまま`Name`の設定の中で、`Style`のプルダウンを開く
- 一番下の`Create a new style..`をクリック

![bg right w:400](images/2021-11-20-02-23-00.png)

---

- Style 名に`Label`と入れる
- Element style は`Text`のまま、テキスト Element のスタイルであることを示しておく
- Use style of は`Text Name`のまま、`Text Name`を元としてスタイルをつくります

![bg right w:400](images/2024-11-21-08-13-53.png)

---

スタイルに Label が指定されるようになっているはずです。

![](images/2021-11-20-02-24-36.png)

個別に指定したスタイルを共通のスタイルとして定義するのではなく、
先にスタイルを定義する方法もありますが、個別でスタイルを
指定したものを共通のスタイルとして設定する方が
デザインビューでイメージを確認しながらつくれるのでやりやすいです。

---

では、定義したスタイルを他のラベルにも適用していきましょう。
shift を押しながら要素を選択すると複数選択ができ、複数要素を一括で操作ができます。

- pet_detail: Image, Category, Birthday, Gender
- pet_register: Name, Image, Category, Birthday, Gender
- pet_weight_register: Weight

ちょっと多くて手間ですね。

最初からスタイルを分けていたら、一カ所のスタイルを変更するだけで済んだので、意味合いが異なる画面要素がでてきたら、スタイル定義しておくということを意識しておくとよいでしょう。

---

## プレビューしましょう

![bg right w:300](images/2024-11-21-08-29-31.png)

Style については以上です。

---

## ロジックを作りこむ

---

## ロジックを作りこむ

アプリケーションには様々なところにロジックが埋め込まれています。

- 画面操作に対するフィードバックを返す
- データを抽出、加工する
- 画面を権限によって切り替える　など様々です

Bubble でも様々なところにロジックを埋め込めるので一緒にやっていきましょう。

---

## 画面操作に対するフィードバックを返す

---

## 画面操作に対するフィードバックを返す

Bubble では画面要素に対してロジックを埋め込めます。
画面操作に対するフィードバックを作り混むのに使えます。

ペットリストにホバーしたら、赤枠が付くような動きをつけてみましょう

![w:800](images/2024-11-21-08-36-30.png)

---

画像 Element にロジックを埋め込んでいきます

- pet_list を開く
- ペット画像の画像 Element をクリックして、設定を開く
- タブから`Conditional`を指定する
- `Define another condition`ボタンをクリックする

ここで条件と条件に合致した場合にプロパティをどう変更するかを定義できます。

![bg right w:600](images/2021-11-20-02-53-06.png)

---

まずは何に関する条件が指定できるか見てみましょう。

- 該当の画像 Element やその親要素や画面内の他の要素
- ログインユーザー
- 新規でのデータ検索
- 現在、日付や現在位置、ページ幅、スクロール位置など現在の状態

という具合に、なんかいろいろな条件が指定できそうなのがわかると思います。

![bg right w:400](images/2021-11-20-02-55-53.png)

---

今回は単純に該当の画像`This Image`を選択しましょう.

すると、次は画像の状態がならびます。ここもいろいろありますが、今回は`is hovered`を選択してください。

これで、該当の画像がホバーされたらという条件になります。

![w:400](images/2021-11-20-03-05-21.png)

---

次に条件に合致した場合に、どのプロパティをどう変更するかという指定をします。
`Select a property to change when true`をクリックして、中を眺めてみましょう。

- 画像のソース、alt 属性
- クリックできるか、ボーダーなど

いろいろ変更出来そうだというのがわかります。
ここに並ぶものは Element の種類によって異なります。

![bg right w:400](images/2021-11-20-03-09-36.png)

---

今回はホバーされたら、赤の枠線が付くようにします

- `Border style - all borders`をクリックする
- `None`となっている箇所を`Solid`に変更する
- 枠線が`なし`と指定されているのを`実線を表示`に変更しているという意味になります。

![bg right w:400](images/2021-11-20-03-16-54.png)

---

- `Select a property to change when true`を選ぶ
- `Border color - all borders`をクリックする
- 色を指定できるようになるので、定義してある Primary を選ぶ
- 同様にして次は、`Border width - all boarders`を指定し、`2`を設定する

![bg right w:400](images/2022-11-26-00-53-18.png)

以上で設定完了です。

---

## プレビューしましょう

ホバーしたら、赤枠がでるようになりました。

![w:700](images/2024-11-21-08-36-30.png)

こうやって、ユーザー操作に対してわかりやすいフィードバックを返したり、画面の装飾を状態によって切り替えたりといったロジックを埋め込んで、プロダクトを作りこんでいくことができます。

---

## データを抽出、加工する

---

## データを抽出、加工する

特定のデータだけを抽出したり、取得したデータを加工や計算して出したりすることができます。
ペットのイニシャル、年齢、最新の体重を表示するようにします。

![bg right w:600](images/2022-11-26-01-27-11.png)

---

## 事前準備

これから要素を追加していくので、Name、Birthday、Gender の幅を縮めておきましょう。

- pet_detail で、Name をダブルクリックして設定を開く
- Shift を押しながら、Name のラベルから Gender のテキスト要素まで追加で選ぶ
- `Layout`タブを洗濯し`Width`と表示されている部分をクリックする
- W(幅)に`120`を指定する
  ![bg right w:400](images/2023-11-09-04-14-57.png)

---

## まずはイニシャルを表示します

- Name のラベルの中身を、イニシャルを含むというのがわかるように`Name (Initial)`に変更する
  ![](images/2021-11-20-03-41-21.png)

---

- Name の内容を出しているテキストを選択する
- テキスト入力欄の文字がない部分をクリックして、フォーカスをあてる
- ` (`と入力する
- `Insert dynamic data`を選択する
- `Current Page Pets`>`'s Name`を選択する
- `Search...`となって続きが選択できるはずです。

ここで様々な加工方法が選択できます。眺めて見ましょう。

![bg right w:400](images/2021-11-20-03-47-44.png)

---

- `truncated to`を選択する
  - これは指定された文字数までを切り取るという意味になります
- `1`と入力して、Enter キーで確定する
- また`Search...`と出る
- `:uppercase`を選択する
  - これは大文字に変換するという意味なります
  - （日本語名をつけている方にとっては意味がないですが）
- テキスト入力欄の文字がない部分をクリックして、`)`を入力する

![](images/2021-11-20-03-52-12.png)

---

## プレビューしましょう

![](images/2024-11-21-08-47-46.png)

---

## 最新の体重を表示します

- Birthday のラベルとテキストをコピー＆ペーストして配置しましょう
- ラベルを`Latest Weight`に変更しましょう

![bg right w:600](images/2022-11-26-01-06-30.png)

---

- Latest Wight の中身を出すテキストの設定を開いて、テキスト入力エリアを空にします
- フォーカスをあてて、`insert dynamic data`をクリックします
- `Do a search for`をクリックします
  - データを検索するという意味ですね

![bg right w:600](images/2021-11-20-04-00-08.png)

---

現在ページで表示しているペットの体重を取得するという指定をします

- `Type`に`PetWeightLogs`を指定する
- `Add a new constraint`ボタンをクリックする
- 条件入力欄が現れるのでクリックして、`Pet`、`=`、`Current Page Pets`の順に指定する

様々な条件で取得ができるので、どんな条件があるのか眺めておきましょう

![bg right w:600](images/2022-11-26-01-08-01.png)

---

作成日の降順、すなわち新しく作られたもの順に並べるという指定をします

- `Sort by`に`WeightDate`を指定する
- `Descending`に`yes`を指定する
- Close する

並び順の指定は忘れがちですが、重要なことが多いです。

![bg right w:400](images/2024-11-21-08-57-33.png)

---

最新の 1 件の体重を表示します

- テキスト入力欄の`More`をクリックして、中身を眺めましょう
- 最初の 1 件目を取得したいので、`:first item`を指定する
- 続いて、`'s WeightKg`を指定する
- 空白部分をクリックして、`kg`と入力する

以上で、最新の体重の設定は完了です。
データ抽出、リスト加工の方法として覚えて起きましょう。

![bg right w:600](images/2021-11-20-04-10-59.png)

---

## プレビューしましょう。

![bg right w:250](images/2024-11-21-08-59-59.png)

---

#### ＜ Advanced ＞

## ちょっと横道にそれて、

## 数値の More、日付の More を眺めてみましょう。

Bubble では数値や日付についても、様々な加工・計算方法が提供されています。

---

#### ＜ Advanced ＞

## 年齢を計算する

次は年齢を出します。先ほど見たとおり、数値や日付の加工・計算はできるのですが、ちょっと年齢計算は難しそうなので、直接コードを埋め込んで実現しようと思います。

Bubble では plugin を導入することで、javascript というプログラミング言語を使った簡易的な処理を動作させることができます。

---

#### ＜ Advanced ＞

javascript のコードを埋め込むためには、`Toolbox`というプラグインを利用します。
インストールしましょう。

- 左メニューの中の`Plugins`を指定
- 検索用のテキストボックスに`tool`と入力（検索には少し時間がかかる）
- 検索結果の一番上にでてくる`Toolbox`の`Install`ボタンを押す

![bg right w:600](images/2021-11-20-04-25-21.png)

---

#### ＜ Advanced ＞

Toolbox でのコードの埋め込み方は大きく 2 つあります、今回は以下の 2 通りを紹介します

- Workflow 上の`Run javascript`で実行／Design 上の`Javascript to Bubble`で受取
  - 複数行にわたるような複雑な処理に使う
- Design 上の`Expression`で実行兼受け取り
  - 単発で終わるような処理に使う

---

#### ＜ Advanced ＞

では、年齢を計算します。
`Run javascript`／`Javascript to Bubble`で行います。まずは、pet_detail 画面に、`Javascript to Bubble`を仕込んでおきます。

- 左メニューの`Visual elements`から`javascript to Bubble`を選択する
- 画面の最下部など邪魔にならない場所におく
- javascript の結果を受け取るためのものなので、プレビューなど実行時には表示されません

![bg right w:400](images/2021-11-20-04-45-28.png)

---

#### ＜ Advanced ＞

- `bubble_fn_suffix`に`age`と指定する
- `Publish value`にチェックする
- `Value type`に`number`と指定する

以上で、`bubble_fn_age`という関数（処理のかたまり）に javascript から値を渡すと、この画面要素で受け取れるようになります。

![bg right w:300](images/2024-11-21-09-07-04.png)

---

#### ＜ Advanced ＞

次に javascript を実行する箇所を定義します。

- 左メニューから Workflow を選択する
- 正方形がならんでいるが、その一番右の`Click here to an event...`を選択する
- `General`>`Page is loaded`を選択する

![bg right w:700](images/2021-11-20-04-52-26.png)

---

#### ＜ Advanced ＞

- `Click here to add an action...`をクリックする
- `Plugins` > `Run javascript`をクリックする
- 設定が開くので、`Script`の欄に次のページのコードを貼り付ける

![bg right w:300](images/2021-11-20-05-00-40.png)

---

#### ＜ Advanced ＞

```
//生年月日
const birthday = {
    year: ,
    month: ,
    date:
  };

function getAge(birthday){

    //今日
    let today = new Date();

    //今年の誕生日
    let thisYearsBirthday = new Date(today.getFullYear(), birthday.month-1, birthday.date);

    //年齢
    let age = today.getFullYear() - birthday.year;

    if(today < thisYearsBirthday){
        //今年まだ誕生日が来ていない
        age--;
    }

    return age;
}

bubble_fn_age(getAge(birthday));
```

---

#### ＜ Advanced ＞

3 行目から 5 行目の、`year: `、`month: `、`date: `の後ろに`insert dynamic data`で年月日を差し込む

- `year: `の後ろ（`,`の前）にカーソルを置く
  - `insert dynamic data`>`Current Page Pets`>`'s Birthday`
  - `More`>`formatted as 11/20/21`
  - `Format type`に`Custom`を指定する
  - `Custom format`に`yyyy`を指定する
- 同様に`month: `の後ろにも、`Custom format`を`m`にして差し込む
- 同様に`date: `の後ろにも、`Custom format`を`d`にして差し込む

※入力後イメージは次のページ

---

#### ＜ Advanced ＞

入力後のイメージ
![w:800](images/2021-11-20-05-20-55.png)

---

#### ＜ Advanced ＞

表示するための画面要素を配置しましょう

- Birthday のラベルとテキストをコピー＆ペースト
- ラベルを Age に変更
- テキストの中身を`JavascripttoBubble A`>`'s value`と指定する

---

#### ＜ Advanced ＞

## プレビューしてみましょう

![bg right w:300](images/2024-11-21-09-14-49.png)

---

#### ＜ Advanced ＞

犬や猫の年齢は

- Visual elements から`Expression`を選択して、先ほどの`Javascript to Bubble`の横辺りに配置する
- Expression に`24 + (`と入力する
- `insert dynamic data`で`JavascripttoBubble A`>`'s value`を差し込む
- 続きに` -2) * 4`と入力する
- Result type に`number`と指定する

![bg right w:500](images/2021-11-20-05-30-14.png)

---

#### ＜ Advanced ＞

表示の設定をします。

- Age のラベルを犬猫年齢も含むことがわかりやすいように、`Age(as Dog/Cat)`と変更する
- Age のテキストの中身に元々入力されているものの後ろに` (`と入力する
- `insert dynamic data`で`Expression A`>`'s value`を差し込む
- `)`と入力する

![bg right w:500](images/2021-11-20-05-34-15.png)

---

#### ＜ Advanced ＞

なお、次に犬猫年齢の計算方法はサイズによっても違うようです。

今回利用した以下の年齢計算は 3 歳以上の小型犬の年齢計算をする場合の式となります。
`犬猫年齢 = 24 + (人間年齢 − 2 ) × 4`

興味があれば、厳密に計算ができるよう作り込んでみましょう。

---

#### ＜ Advanced ＞

## プレビューしてみましょう

![bg right w:300](images/2024-11-21-09-26-13.png)

---

## 画面を権限によって切り替える

---

## 画面を権限によって切り替える

ここまで、画面操作へのフィードバックやデータの抽出・加工など部分部分でのロジックの組み込みを説明してきました。

次は、複数機能にまたがるようなロジックをいれていこうと思います。

以下のことを行います。

- ユーザーをペットの飼い主（Pet Owner）とペットの飼育アドバイザー（Pet Advisor）に分ける
- 飼い主は今まで作ってきた画面・機能を利用できる
- アドバイザーはアドバイザー専用の画面・機能を利用できる

---

開発の流れとしては以下の順番に作り混んでいきます。

- ユーザー情報に飼い主かアドバイザーかを判別できるフィールドを追加する
- ユーザー登録時に、飼い主かアドバイザーかを選択して登録できるようにする
- アドバイザーの一覧画面、詳細画面を作成する
- 飼い主かアドバイザーかによって、ログイン後・サインアップ後の画面遷移先を切り替える

手順は多くかかりますが、複数のユーザー種別を扱うプロダクトはよくありますので、ぜひ身につけていきましょう

---

## ユーザーを判別できるフィールドを追加する

まずは飼い主かアドバイザーかという役割の違いをデータ上保持できるようにします。

ペットのオスメスの時のようにテキストで保持してもよいのですが、決まった選択肢の中から指定するような値は、選択肢をあらかじめ定義して利用することで扱いやすくなります。Bubble から Option set という仕組みが提供されているので、それを使ってみましょう。

---

Options を設定してみましょう

- 左メニューの`Data` > タブの`Option sets`と移動する
- `New Option set`に`Role`と入力して、Create ボタンを押す
- 新たな Option set として Role が作成されます

![bg right w:600](images/2021-11-20-06-14-02.png)

---

Role という Option set（選択肢のセット）に、具体的な Option（選択肢）を追加していきます。今回は、`Pet Owner`と`Pet Advisor`を作成します。

- 画面右下の`New Option`に`Pet Owner`と入力して、Create ボタンを押してください
- 同様に`New Option`に`Pet Advisor`と入力して、Create ボタンを押してください

以上で設定完了です

![bg right w:800](images/2021-11-20-06-17-29.png)

---

次はユーザーの属性として、ロールを追加しましょう

- 左メニューの`Data` > タブの`Data types`と移動する
- `User`を選択する
- 画面右下の`Create a new field`ボタンをクリックする

![bg right w:600](images/2021-11-20-06-20-20.png)

---

- `Field name`に`Role`と入力する
  - これはわかりやすいものであれば、どういう名前でも構いません
- `Field type`に`Role`を選択する
  - ここで指定しているのは先ほど作成した`Option set`としての`Role`になります。
- Create ボタンを押す

![bg right w:600](images/2021-11-20-06-23-26.png)

---

新しくフィールドを追加したので、既に作成してしまっているユーザーについては Role が空になってしまいます。後々、不整合を招きますので、既存データにパッチ（データ補正）をあてておきましょう。

- `App Data`タブ荷移動して、`All Users`を選択する
- 表が表示されるので、表の左端のペンアイコンをクリックして、1 件ずつ編集する
  - 今作成されているユーザーはすべて飼い主のはずなので、`Role`に`Pet Owner`を指定する
    ![](images/2021-11-20-06-27-18.png)

---

Users の中のすべての行がの`Role`が`Pet Owner`になっていれば OK

![](images/2021-11-20-06-29-53.png)

---

## ユーザー登録時にロールを指定できるようにする

では、次はユーザー登録時に飼い主なのかアドバイザーなのか指定して登録できるようにします。

登録画面は Bubble が用意しているものを使い回してきましたが、そこに手を入れます。

---

- ログインページ`index`に移動する
- `Password`のラベルをコピーして、`Role`というラベルを配置する
- `Design`メニューの`Input forms`の中から`Dropdown`を選択して、パスワード入力欄の下に配置する

![bg right w:300](images/2024-11-21-22-03-38.png)

---

- Dropdown の設定は以下のとおりとする
  - Element 名：`Dropdown Role`
  - Placeholder: `Choose a role...`
  - `Choice style`：`Dynamic choices`
  - `Type of choices`: `Role`
  - `Choices source`: `All Role`
  - `Option caption`: `Current option`>`'s Display`
  - `Default value`: `Pet Owner`
  - `This input should not be empty`: チェック

※画面イメージは次のページ

---

入力後イメージ
![w:300](images/2024-11-21-22-05-41.png)

---

つづいて、入力された Role がユーザー登録時に設定されるようにします

- 左メニューから`Workflow` > 並んでいる正方形の中から`Button Sign up is clicked` > 並んでいる Action から`Sign the user up`の順に移動する
- Action の設定画面内の`Change another field`ボタンをクリックする
- 入力欄がでてくるので、`Role` = `Dropdown Role` `'s value`と選択する

![bg right w:600](images/2021-11-20-06-45-29.png)

---

## プレビューと動作確認をしましょう

アドバイザーとして、アカウント登録して、データを確認してみましょう。

![w:900](images/2023-11-09-05-01-43.png)

---

## アドバイザーの一覧画面を作成する

アドバイザーの一覧画面を作りましょう

- b ロゴ横のメニューを開いて、`Add a new page...`
- `Page name`に`pet_list_for_advisor`と入力する
- `Clone from`で`pet_list`を選ぶ
- 新しく画面が作成される

![bg right w:600](images/2021-11-20-06-59-31.png)

---

アドバイザーは登録されたすべてのペットを参照できるようにします。

- もとの検索条件を削除する
  - pet list を選択して、Data source の`Do search for`をクリックする
  - `Created By = Current User`と条件指定されている部分をゴミ箱アイコンをクリックして削除
- アドバイザーはたくさんのペットを閲覧する必要があるので、セルのサイズは小さくする。
  - `Min width`に 120 と`Min height`に 100px を指定

![bg right w:600](images/2024-11-21-22-18-33.png)

---

### プレビューしましょう

まだログイン後の遷移先は通常のペットリストになっているので、Preview ボタンから直接アドバイザー用のペットリストを開きます。

...何も出ない！？なんで？？

![w:600](images/2024-11-21-22-14-23.png)

権限がないからです。

---

### Bubble での権限制御

今まで意識しなくてよかったですが、Bubble では Data へのアクセスが厳密に制限されています。

左メニューの`Data` > タブの`Privacy`と移動してください。
初期状態では、データは作成者しかアクセスできなくなっています。

当然と言えば当然ですね。

![bg right w:600](images/2021-11-20-07-26-09.png)

---

では、アドバイザーだったら、すべてのデータを見れるという権限を追加していきます。

- `Data`タブから、さらに`Privacy`タブの中で、`Pets`を選択する
- `Define a new rule`ボタンをクリックする
- Rule name に`Visible to advisor`と入力する
- When に`Current User` `'s Role` `is` `Pet Advisor`と選択する
  - ユーザーがアドバイザーだった場合という条件です

これでアドバイザーだったら、すべてのペットのデータが見れます。
ルールごとに参照できるフィールドを限定することもできますが、今回は利用しません。

※画面イメージは次のページ

---

![](images/2021-11-20-07-32-23.png)

では、同じように`PetWeight`にもルールを追加してください。
これでアドバイザーはすべてのデータを見れるようになっているはずです。

---

## プレビューしましょう

一覧に表示されましたか？他の Pet Owner のユーザーを作ってペットを登録してもこちらに表示されます。

![](images/2024-11-21-22-20-44.png)

---

次に、ログイン時の遷移先を制御します。

アドバイザーの場合は、pet_list に遷移した際に、pet_list_for_advisor に遷移するという Action を追加します

---

- pet_list ページの Workflow をひらく
- `Click here to add an event..`をクリックする
- `General` > `Page is loaded`を選択
- `Click here to add an action..`をクリックする
- `Navigation` > `Go to page..`をクリックする
- 設定が開くので、Destination に`pet_list_for_advisor`を選択する
- `Only when`に`Current User` `'sRole` `is` `Pet Advisor`を選択する

![bg right w:700](images/2022-11-26-02-24-57.png)

---

## プレビュー＆動作確認しましょう

アドバイザーでログインしたら
![](images/2024-11-21-22-24-07.png)

---

飼い主でログインしたら
![w:800](images/2024-11-21-22-25-08.png)

よしよし

---

#### ＜ Advanced ＞

## アドバイザーで勝手にアカウント作られて、

## 勝手に情報見られていいの？

---

#### ＜ Advanced ＞

## システム管理者が承認しないと、利用開始出来ないようにしよう

---

#### ＜ Advanced ＞

## 以下をやっていきます

- ユーザー情報にアドバイザーとして承認されているかを示すフィールドを追加する
- データへのアクセス権限はアドバイザーであることと同時に、承認されていることを条件に加える
- アドバイザー用のペットリストには、未承認だったら審査中ですというメッセージをだす

---

#### ＜ Advanced ＞

## ユーザー情報にアドバイザーとして承認されているかのフィールドを追加する

- 左メニューから`Data`>タブの`Data types`>中の`User`とクリックしていく
- 画面右下の`Create a new field`ボタンをクリックする
- Field name に`Approved As Advisor`と入力する
- Field type に`yes/no`を選択する
- Create ボタンをクリック

![bg right w:600](images/2021-11-20-08-15-18.png)

---

#### ＜ Advanced ＞

追加されたフィールドに`default`という欄があるので、`no`（もしくは`いいえ`）を設定しておく。
作成されたタイミングでは、未承認状態となる。

![](images/2021-11-20-08-18-00.png)

---

#### ＜ Advanced ＞

既存のユーザーについては、`Approved As Advisor`はすべて`no`にしておく
(めんどうで、しょんぼり。。。だけど、大事！)

![](images/2021-11-20-08-21-51.png)

---

#### ＜ Advanced ＞

## データへのアクセス権限は承認されているかも見る

- 左メニューから`Data`>タブの`Privacy`>中の`Pets`とクリックしていく
- `Visible to advisor`の When の条件が記載されている部分の末尾の`Pet Advisor`をクリックする
- `More`があらわれるので`More`をクリックする
- `and` `Current User` `'s Approved As Advisor` `is "yes"`と選択する
- `PetWeight`も同様にする

---

#### ＜ Advanced ＞

動作確認してみよう
`Approved As Advisor`が`no`のユーザーでログインしてみる

![](images/2024-11-21-22-30-39.png)

よし

---

#### ＜ Advanced ＞

データを直接編集して`Approved As Advisor`が`yes`にしたら？

![](images/2024-11-21-22-31-33.png)

よし

---

#### ＜ Advanced ＞

## 未承認だったら審査中ですというメッセージをだす

- pet_list_for_advisor の画面で`Design`メニューを開く
- `Popup`を追加する
- `Layout`タブで、`Container laout`に`Align to parent`を指定する。
- `Popup`の上にテキスト Element を追加する。
- 審査中である旨のメッセージを記載する
- `Layout`タブで、親要素に対して中央に表示されるように指定する。
  ![bg right w:700](images/2021-11-20-08-33-33.png)

---

#### ＜ Advanced ＞

- メニューから Workflow に移動する
- `Click here to add an event..`>`Page is loaded`とクリックする
- `Click here to add an action..`>`Element Actions`>`Show`とクリックする
- Element に`Popup A`を指定する
- Only when に、`Current User` `'s Approved As Advisor` `is "no"`を指定する

![bg right w:600](images/2021-11-20-08-38-07.png)

---

#### ＜ Advanced ＞

## 動作確認してみよう

yes のアドバイザーなら
![](images/2024-11-21-22-41-59.png)

よし

---

#### ＜ Advanced ＞

no なら
![](images/2024-11-21-22-41-32.png)

よし

---

#### ＜ Advanced ＞

## システム管理者はどうやって気づくの？

---

#### ＜ Advanced ＞

## アドバイザーの登録がされたら、システム管理者にメール通知されるようにしょう

---

#### ＜ Advanced ＞

## システム管理者にメール通知されるようにしょう

- `index`ページを開く
- メニューから Workflow に移動して、`Button Sign up is clicked`を選ぶ
- `Click here to ad an action...`> `Email`>`Send Email`とクリックする
- Action の位置を`Go to page pet_list`の前にドラッグして移動する

![bg right w:500](images/2024-11-21-22-45-18.png)

---

#### ＜ Advanced ＞

- To に自分のメールアドレスを設定する
- Sender name は`PetLog`
- Subject は `New Advisor Requested`
- Body は以下の本文の末尾に`dynamic data isert`で`Current User` `'s email`を選択

```
New Advisor has been Registered.
Please check it.

Email:
```

---

#### ＜ Advanced ＞

- Only when に、`Current User` `'s Role` `is` `Pet Advisor`を指定する

![bg right w:400](images/2024-11-21-22-48-52.png)

---

#### ＜ Advanced ＞

## 動作確認してみよう

アドバイザーでサインアップしたら
![w:600](images/2021-11-20-08-50-37.png)
きたきた

---

#### ＜ Advanced ＞

飼い主なら

うん、こない。やったー

---

### ここまでのおさらい

---

### デザインを作り込みました

- ディスプレイサイズに合わせた画面をつくりました
  - レスポンシブウェブデザインという手法を使って、以下のようなルールを用いて、ディスプレイサイズに合わ見た目を制御しました.
    - 親要素内の配置ルール
    - 要素のサイズ決定ルール
    - 表示の有無ルール
- Style を使ってみました
  - Style を編集・追加したり、個別にスタイルをあてました

---

## ロジックを作りこみました

- 画面操作に対するフィードバックを返しました
- データを抽出、加工しました
- 画面を権限によって切り替えました

Bubble で様々なところにロジックを埋め込めるのを一緒に見ていきました

---

#### ＜ Excercise ＞

## 演習

ここまでで学んだ、デザインやロジックの作り込み方を使って、機能を追加してみよう。

例えば、アドバイザーから飼い主、もしくは飼い主からアドバイザーにアプローチできる機能をつくって見よう

- 例：飼い主にアドバイスを送れる
- 例：広告を掲載できる
- 例：アドバイザーに相談を投げられる　などなど

---

## ここまでのふりかえり

ここまでで、Bubble 単体での講義は終わりになります。

触れられなかった機能もたくさんありますが、
Bubble はマニュアルとリファレンスが充実していますので、
もし Bubble を採用するならぜひ活用してください。

マニュアルはこちらです。
https://manual.bubble.io/

リファレンスは画面上でわからないものにカーソルを合わせると現れます。
だいたいの機能についてリファレンスへのリンクが浮き出てきます。

このあとは Bubble を他のシステムと連携したりチームで開発することを学んでいきます。

---

# 外部システムと連携する

---

以下のように様々なシステムと連携して機能を作っていきます。

- ChatGPT を使って AI ペットアドバイザーを作成
- YouTube の動画一覧を表示
- Google アカウントを使ったソーシャルログイン
- YouTube の動画一覧を動的に検索

---

## ChatGPT を使って AI ペットアドバイザーを作成

まず、一つ目のシステム連携では、ChatGPT と連携して、ペットの状態を考慮したアドバイスをできる機能をつくっていきます。

ChatGPT との連携には、Open AI 社が提供している API を利用します。

---

## API って何？

「API（Application Programming Interface）」のことで、ソフトウェアやアプリケーションが他のソフトウェアやサービスと通信するための方法です。API を通じて、アプリケーションはデータを共有したり、他のアプリケーションの機能を公開し、利用することができます。

![w:650px](images/2023-11-10-11-47-39.png)

---

## Bubble での API 連携の準備

Bubble では、API と簡単に接続できるようにしてくれるプラグインが提供されています。準備していきましょう。

- 左メニューから Plugins を選択し、Add plugins ボタンをクリック
- "API" で検索し、 `API Connector` というプラグインをインストールします

![bg right h:500px](images/2021-11-25-20-24-21.png)

---

- このプラグインは Bubble のアプリから、世の中で公開されている API を使って、API の向こう側の情報と Bubble を繋げるためのプラグインとなります
- いくつかの Bubble のプラグインの中には、特定の API に特化させたものもあり、それらのプラグインはこの API Connector よりも設定が単純なものもあります
- 今回は一番の基本形となる API Connector プラグインを介して ChatGPT API や YouTube API を使い、機能を組み込んでいきます。

---

## ChatGPT(Open AI) での API 連携の準備

Open AI の API を利用するには、以下の画面から Open AI のアカウントを作成し、支払方法の登録や API キーを発行をする必要があります。

https://platform.openai.com/

今回はそれらの手順は割愛して、事前に準備している API キーを Slack 共有しますのでそちらを利用していきましょう。

ただし、この場以外への公開やこの場でも使い過ぎないよう気を付けてください。（課金が爆発してしまうのでｗ）

---

## 参考 URL

ドキュメント
https://platform.openai.com/docs/overview

API リファレンス
https://platform.openai.com/docs/api-reference/introduction

利用料金
https://openai.com/api/pricing/

管理画面
https://platform.openai.com/settings/organization/projects

---

- それでは ChatGPT API を使うための設定を行っていきます
- Plugins タブで Installed Plugins の中から "API Connector" を選択
- 右パネルにこのプラグインの概要が記載されているので、その下にある "Add another API" をクリックし、新しい API 連携の設定を開始します

![w:650px](images/2021-11-25-20-31-17.png)

---

- "Add another API" をクリックすると、このような API 設定部品が表示されると思います
- 各項目の簡単な説明と設定をしていきます

![w:950px](images/2022-11-23-16-09-10.png)

---

1. API Name: この API 連携のグループ名

- 今回は ChatGPT

![w:1000px](images/2024-11-22-00-13-45.png)

---

2. Authentication: このグループ配下の API で行う共通の認証方式

- 今回は "None or self-handled"

![w:1000px](images/2024-11-22-00-13-45.png)

---

3. Shared headers for all calls: このグループ配下の API すべてで指定する共通のヘッダー情報

ChatGPT API では、ヘッダーに API キーをつけて接続する必要があります。キーを設定しましょう。

- `Add a shared head`をクリック
- `Key`に`Authorization`と入力
- `Value`に`Bearer` + ` `(半角スペース)+ slack で共有した API キー を指定してください。

---

すべて入力したらこうなります。

![w:800](images/2024-11-22-00-21-50.png)

---

4. Shared parameters for all calls: このグループ配下の API すべてで指定する共通のパラメータ情報

- 今回は特に指定しません

![w:800](images/2024-11-22-00-21-50.png)

---

- 続いて、このグループに対して具体的な API の内容を設定していきます
- 先ほどの画面で "API Call" となっているブロックの右側に expand というリンクがあるのでそれをクリック
- すると、具体的な API の設定項目が表示されますので、簡単に説明します

![w:800px](images/2022-11-23-16-14-34.png)

---

1. Name: 具体的な API の名前

- 今回は "chat/completions" と入力します

![w:800](images/2024-11-22-00-26-23.png)

---

2. Method: 接続時の http メソッド

- 今回は `POST` を選択します

![w:800](images/2024-11-22-00-26-23.png)

---

3. Path: 具体的な API の URL

- 今回は `https://api.openai.com/v1/chat/completions` を入力します

![w:800](images/2024-11-22-00-26-23.png)

---

4. Body: リクエストの本文です

- 今回は後述の内容をまず入力してください。

![w:800](images/2024-11-22-00-26-23.png)

---

```
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": "Hello!"
    }
  ]
}
```

これは、ChatGPT API のドキュメントに記載されているサンプルリクエストの内容になります。
https://platform.openai.com/docs/api-reference/chat

---

すべて入力したらこうなります。

![w:800](images/2024-11-22-00-31-10.png)

---

- 設定が終わったら、設定内容が正しいかを確認します
- 下部にある "Initialize call" ボタンをクリック
- 成功すると "Returned values - search" というポップアップが表示されるはずです

![bg right w:600](images/2024-11-22-00-32-21.png)

---

- これは今回設定した "https://api.openai.com/v1/chat/completions" の API を実行した結果（レスポンス）の情報を表しています。
- Bubble の API Connector ではこのように、実際にリクエストを送信してみて、受け取った結果を解析してこのように Bubble 上で使いやすいように設定できるようになっています。

![bg right w:600px](images/2022-11-23-16-28-15.png)

---

詳しくは割愛しますが、ポイントとしては下記 3 つです。

- `choices(list)` となっている部分が回答メッセージが格納されている一覧になります
- その型となるのが `chat/completions choice` という型となることを表しています
- 回答内容が `message content` となっている項目です

参考：chat completion object のリファレンス
https://platform.openai.com/docs/api-reference/chat/object

---

- 特に参照しない項目については紛らわしいのでプルダウンの中から `Ignore field` を選択しておきます
- こうすることで、Dynamic data として扱う時に、選択肢の中に表示しないようになり、設定項目を選ぶ際に悩まずに済みます
- 設定が完了したら "SAVE" をクリックして、設定内容を保存しておきます

![bg right w:600](images/2024-11-22-00-41-22.png)

---

## 続いて、リクエストの本文を指定していきます

リクエストは JSON という構造化された書式で記載されています。各項目は以下の意味を持ちます。

- `model`: 利用するモデルです。GPT はサイズや性能の異なる複数のモデルが提供されています。今回は軽量で安価な`gpt-4o-mini`を使って検証してみます。
- `messages`: GPT にコンテキストとして与えるメッセージ群になります。GPT は、大雑把に言うと文書の続きをとても上手く書くことができる言語モデルです。続きの元となるコンテキストを`role`(役割)と`content`(内容)のセットで記載して、連ねていくことでそのコンテキストに沿ったつづき(回答)を返してくれます。

与えるコンテキストはチャットに対する指示にあたるため、プロンプトと呼ばれています。

参考：create chat completion のリファレンス
https://platform.openai.com/docs/api-reference/chat/create

---

今回はペットの登録内容と買い主の相談メッセージに基づいて、アドバイスを返してくれる機能を組み込みます。

Body に記載する内容は、`<name>`のように`<>`で括って名前をつけて埋め込んで置くことで、後ほど API を呼び出す際に Bubble から中身を埋め込むことができます。

---

以下のようにコンテキストを与えることとします。

```
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "ペットの飼育アドバイザーとして回答してください。
      ペットの名前、生年月日、カテゴリー、最新の体重、最新の体重の計測日が
      飼い主であるユーザーから伝えられます。また、さらに飼い主からペットに
      対する相談内容も伝えられます。それらに基づいて、ペットの飼育への
      アドバイスを回答してください。なお、回答の冒頭で確認のために、
      与えられた情報である名前、生年月日、カテゴリー、最新の体重、
      最新の体重の計測日、相談内容に触れるようにしてください。"
    },
    {
      "role": "user",
      "content": "ペットの名前：<name>、ペットの生年月日：<birthday>、
      ペットのカテゴリー：<category>、ペットの最新の体重：<weight>、
      ペットの最新の体重の計測日：<weightDate>、相談内容：<content>"
    }
  ]
}
```

※上記の内容は、改行をいれて整形しているため、そのまま貼り付けても利用できません。

---

以下を Body に貼り付けてください。

```
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "ペットの飼育アドバイザーとして回答してください。ペットの名前、生年月日、カテゴリー、最新の体重、最新の体重の計測日が飼い主であるユーザーから伝えられます。また、さらに飼い主からペットに対する相談内容も伝えられます。それらに基づいて、ペットの飼育へのアドバイスを回答してください。なお、回答の冒頭で確認のために、与えられた情報である名前、生年月日、カテゴリー、最新の体重、最新の体重の計測日、相談内容に触れるようにしてください。"
    },
    {
      "role": "user",
      "content": "ペットの名前：<name>、ペットの生年月日：<birthday>、ペットのカテゴリー：<category>、ペットの最新の体重：<weight>、ペットの最新の体重の計測日：<weightDate>、相談内容：<content>"
    }
  ]
}
```

---

すると、`<>`で囲んだ項目が Body の入力エリアの下部に並びます。`Private`のチェックをはずしてください。こうすることで、後ほど Bubble で呼び出す際に動的に指定できます。

![w:800](images/2024-11-22-01-52-36.png)

---

## 画面に組み込んでみましょう。

pet_weight 画面を元に新しくページを作ります。

- b ロゴ右側のメニューを開き、`Add a new page`
- `Page name`に`pet_consult`と入力
- `Clone from`に`pet_weight`を選択して、`Create`ボタンをおす。
- 画面が作成されたら、グラフ以下の要素を全部削除する。

![bg right w:300](images/2024-11-22-01-19-43.png)

---

GPT の回答は長文になるので、全て表示しきれるよう画面の縦幅を大きめにとっておきましょう。（この画面はレスポンシブの設定をしていないので、伸縮してくれません）

- 画面の外枠をクリックして、`pet_consult`の設定ウィンドウを呼び出す。
- `Height`に`1500`を指定する。

![](images/2024-11-22-02-32-02.png)

---

次に入力用の要素を配置していきます。右のように要素を配置してみましょう。

- 説明分のテキスト
- メッセージ入力用のインプット
- 送信用のボタン
- 回答を表示するためのテキスト

やり方はわかりますね。
![bg right w:400](images/2024-11-22-02-33-29.png)

---

また回答出力用の要素を配置していきます。回答を受けとるためには Type を定められる`Group`や`RepeatingGroup`といった Container 要素で受ける必要があります。

今回は繰り返し表示は必要ないので、`Group`を配置しましょう。長文の回答を表示しきれるように、`H`を`1000`にしておいてください。

![bg right w:350](images/2024-11-22-02-37-54.png)

---

Type を指定しておいてください。先ほど API の設定で定めた、`chat/completions choice`という Type を指定します。

![bg right w:400](images/2024-11-22-02-39-43.png)

---

今度は回答のテキストを表示できるように、作成した`Group`の中にテキストを配置しましょう。`Group`のサイズ内いっぱいまで表示できるよう、右のように設定してください。

ポイントは、幅や高さは固定しない、高さはコンテンツに合わせるという設定にしているところになります。

![bg right w:350](images/2024-11-22-03-21-54.png)

---

このような見た目になります。

![bg right w:300](images/2024-11-22-02-45-26.png)

---

では、ボタンを押したときの動作を設定しましょう。

- `Send`ボタンをクリックし、設定ウィンドウを開く
- `Appearance`タブの中の`Add workflow`ボタンを押す
- Workflow の設定画面で`Click here add an action...`を押す
- `Element Actions`の`Display data`を選択する

要素に対して取得したデータを表示するという action になります。

![bg right w:500](images/2024-11-22-02-49-23.png)

---

`Display data`にて、画面の内容を元に API から回答を取得する設定をいれていきます。

- `Element`に`Group chat/completions choice`を指定する。先ほど画面に配置した`Group`ですね。
- `Data to display`で`Get data from an external API`を指定する。外部 API からデータを取得するという指定になります。
- `API provider`に`ChatGPT - chat/comletions`を指定する。前準備で API Connector で作成した設定ですね。

![bg right w:600](images/2024-11-22-02-55-01.png)

---

次に画面の情報を指定していきます。右の様に設定してください。

![bg right w:400](images/2024-11-22-02-57-51.png)

---

`weight`と`weightDate`については、PetWeight のデータの中から検索してくる必要があります。

- `weight`の欄で`Do a search for`を選択
- `Type`に`PetWeight`を指定
- `Add a new constraint`を押し、` Pet``=``Current page's Pet `を指定。
- `Sort by`で`WeightDate`を指定し、`Descending`に`yes`を指定する。
- `Close`する。

![bg right w:400](images/2024-11-22-03-04-59.png)

---

表示しているペットの体重を新しい順に取得しているので、その中の最初の体重を採用するようにします。

- `:first item`を指定します
- `'s WeightKg`を指定します。

![w:800](images/2024-11-22-03-08-21.png)

---

同様にして、`weightDate`は最新の体重の日付けを取得するように設定してください。

![w:800](images/2024-11-22-03-09-58.png)

---

`Display data`のウィンドウに戻り、` 's choices``:first item `を指定します。

ChatGPT では、複数回答から選択することができるような使い方があるため複数とれるような構造になっていますが、今回の用とでは 1 つしか回答を取得しないので、1 つ目を指定します。

![w:500](images/2024-11-22-03-13-30.png)

これで表示の準備は整いました。

---

最後に、ペット詳細からのリンクを配置しましょう。

- `Design`ビューで`pet_detail`を開く
- `View Weights`のリンクをコピーして下に配置し、リンク名を`Consult`にする。
- 遷移先を`pet_consult`に変更する

![bg right w:600](images/2024-11-22-03-17-03.png)

準備完了です。

---

## 動作確認してみましょう。

![bg right w:300](images/2024-11-22-03-20-25.png)

---

以上で、ChatGPT との連携については完了です。

ChatGPT などの LLM はプロンプトを工夫すれば様々な振る舞いができるので、ノーコードとツールとうまく組み合わせれば、簡単に強力な機能をつくれることがあります。

また、取得した回答をデータベースに格納して履歴参照したり、会話を続けたりといったこともできます。

いろいろなアイデアが手軽につくれて楽しいので、ぜひやってみてください。

---

## YouTube の動画一覧を表示

---

##### まずは土台となるアプリケーションを新たに用意

- 本日の前半で使ったアプリケーションをコピーして使い回したいと思います
- https://bubble.io/home?tab=apps にアクセス

---

- 各自のアカウントで作成している Bubble アプリの一覧が表示されます
- その中で、先ほどまで作ってきたアプリケーションを選択して、ポップアップの最下部にある`Duplicate app`をクリック

![bg right w:600px](images/2023-11-09-12-34-49.png)

---

- コピー後のアプリケーション名の入力ダイアログが表示されるので、適当な名前を入力
- 以前のデータは使い回さないので `Copy the application database content` のチェックは OFF のまま
- COPY をクリック

![bg right w:500px](images/2023-11-09-12-36-50.png)

---

- コピーが終わると、コピーしたアプリケーションの編集画面（index）が表示されれば OK です

![w:800](images/2024-11-22-03-41-30.png)

---

##### YouTube 連携の事前準備

- 続いて、YouTube の動画一覧を表示するために必要な下準備を行います
- 今回の講義では Google が提供しているクラウドサービス "Google Cloud Platform" に用意されている各種 API を使っていきます
  - コンピューティングやストレージ、データベース、ネットワークなど開発に必要なあらゆるツールやインフラがサービスとして提供されているプラットフォームです。
  - 他にも、Amazon が提供している "Amazon Web Service" (AWS) 、Microsoft が提供している Azure といった有名なものがあります。
  - （余談ですが、これらのサービスが世に現れたことで自前のサーバーが要らなくなり、世の中のソフトウェア開発の敷居は一気に下がったのです）

---

- 下記 URL にアクセス
  - https://console.developers.google.com/
- ご自身の Google アカウントでログインしてください
  - もし、Google アカウントをお持ちでない方は、アカウントの作成をお願いします

![bg right w:550px](images/2022-11-23-15-44-32.png)

---

- ログイン後、はじめて Google Cloud Platform(GCP) の画面にアクセスするとこのようなダイアログが表示されますので、国を選択し、利用規約にチェックを入れて「同意して続行」

![w:600px](images/2021-11-25-20-10-55.png)

---

- 同意すると、API とサービスのダッシュボードが表示されると思いますので、プロジェクトを作成のリンクを押下して今回の講義用のプロジェクト（箱）を作成します

![w:1000px](images/2021-11-25-20-12-13.png)

---

- 新しいプロジェクトの作成画面が表示されるのでプロジェクト名に適当な名前を指定して作成

![bg right h:460px](images/2021-11-25-20-13-50.png)

---

- 作成が完了すると、作成したプロジェクトのダッシュボードが表示されます
- 画面上部の Google Cloud の左隣に作成したプロジェクト名が表示されていれば OK

![bg right w:600px](images/2022-11-23-15-58-15.png)

---

- 続いて YouTube の動画一覧を表示するために必要な認証キーを発行していきます
- API とサービスというメニューを開くため、画面上部の検索ボックスに "API" と入力

- サジェスト候補の中から "プロジェクトとページ" ブロックにある "API とサービス" を選択

![bg right h:400px](images/2023-11-09-05-59-06.png)

---

- API とサービスページが開いたら、左メニューから「認証情報」を選択
- 右パネルが認証情報に変わるので、画面上部の「＋ 認証情報を作成」をクリック
- ポップアップから「API キー」を選択

![w:800px](images/2022-11-23-16-01-40.png)

---

- すると API キー作成完了のポップアップが表示されるので、その値を控えておきます
- キーを制限しろと言われますが、講義の最後にこれらのキーを削除しますので一旦このまま行きます

![bg right h:350px](images/2022-11-23-16-02-41.png)

---

- これで Bubble から YouTube の一覧を取得するためのキーが発行できたので Bubble 側の設定を行っていきます
- まずは Bubble から YouTube の一覧を API を介して取得するための準備を行います

---

- それでは YouTube API を使うための設定を行っていきます
- 先ほど ChatGPT API との連携で使用した、 "API Connector" を使用します
- `Plugins`のメニューから`API Connector`を選択し、画面下部にある "Add another API" をクリックし、新しい API 連携の設定を開始します

![w:600](images/2024-11-22-03-54-33.png)

---

1. API Name: この API 連携のグループ名。今回は YouTube

![w:1000px](images/2022-11-23-16-12-12.png)

---

2. Authentication: このグループ配下の API で行う共通の認証方式

- 今回は "None or self-handled"

![w:1000px](images/2022-11-23-16-12-12.png)

---

3. Shared headers for all calls: このグループ配下の API すべてで指定する共通のヘッダー情報

- 今回は特に指定しません

![w:900px](images/2022-11-23-16-12-12.png)

---

4. Shared parameters for all calls: このグループ配下の API すべてで指定する共通のパラメータ情報

- 今回は特に指定しません

![w:900px](images/2022-11-23-16-12-12.png)

---

- 続いて、このグループに対して具体的な API の内容を設定していきます
- 先ほどの画面で "API Call" となっているブロックの右側に expand というリンクがあるのでそれをクリック

![w:800px](images/2022-11-23-16-14-34.png)

---

- すると、具体的な API の設定項目が表示されますので、簡単に説明します

![w:900px](images/2022-11-23-16-15-18.png)

---

1. Name: 具体的な API の名前

- 今回は "search" と入力します

![w:800px](images/2022-11-23-16-20-11.png)

---

2. Path: 具体的な API の URL

- 今回は `https://www.googleapis.com/youtube/v3/search` を入力します

![w:700px](images/2022-11-23-16-20-11.png)

---

3. Headers: この API 固有のヘッダー情報

- 今回は特に指定しません

![w:800px](images/2022-11-23-16-20-11.png)

---

4. Parameters: この API 固有のパラメータ情報

- 今回は下記 2 つのパラメータを指定します。Private / Allow blank / Optional は添付の通り
  1. Key: `key`、 Value: 先ほど Google アカウント側で発行した API キー
  2. Key: `q`、Value: YouTube で動作検索をする際のキーワード（ご自由に指定ください）

---

- すべて設定するとこんな感じです

![w:950px](images/2022-11-23-16-21-06.png)

---

- 設定が終わったら、設定内容が正しいかを確認します
- 下部にある "Initialize call" ボタンをクリック

---

- おそらく Status code 403 のエラーメッセージが返ってきたはずです
- 内容は書いてある通りですが、要約するとこんな感じです

> YouTube Data API v3 はあなたのプロジェクトで無効になっています。
> この URL にアクセスして有効にしてから再試行してください。

![bg right h:500px](images/2022-11-23-16-22-26.png)

---

- どうやら今回利用した YouTube Data API が各人の Google アカウント上で有効になっていないようです
- これは Google さんが全員が使わないであろう機能は最初から OFF にしていて、必要ある人だけ自分で ON にしてね、という状態になっています
- なので今回は YouTube Data API を使いたいので、メッセージに記載されている URL にアクセスして有効化しましょう
  https://console.developers.google.com/apis/api/youtube.googleapis.com/overview?project={各人のプロジェクトID}

---

- すると親切に今回利用したい "YouTube Data API v3" の画面へ遷移したはずです
- 画面にあるとおり「有効にする」をクリックして有効にします

![w:1000px](images/2022-11-23-16-26-30.png)

---

- しばらくするとこんな画面に遷移するはずです
- 画面上部の赤線部分が「API を無効にする」となっていれば有効化は成功です

![w:900px](images/2022-11-23-16-27-18.png)

---

- YouTube Data API が有効化できたので、再度 Bubble の画面に戻り "Initialize call" ボタンをクリック
- 成功すると "Returned values - search" というポップアップが表示されるはずです

![bg right h:600px](images/2021-11-25-20-57-48.png)

---

- これは今回設定した "https://www.googleapis.com/youtube/v3/search" の API を実行した結果（レスポンス）の情報を表しています

![bg right w:600px](images/2022-11-23-16-28-15.png)

---

詳しくは割愛しますが、ポイントとしては下記 3 つです。

- `items(list)` となっている部分が検索結果の動画一覧が格納されている一覧になります
- その型となるのが `search item` という型となり、検索結果に含まれる複数系のデータであることを表しています
- そして、この後の設定で特に重要なのが `id videoId` となっている項目です

---

- YouTube を見たことがある人なら分かると思いますが、この VideoId というのが、それぞれの動画を一意に識別する情報となっており、画面表示するときにもこの Id が必要となります
- その他、特に参照しない項目については紛らわしいのでプルダウンの中から `Ignore field` を選択しておきます
- こうすることで、Dynamic data として扱う時に、選択肢の中に表示しないようになり、設定項目を選ぶ際に悩まずに済みます

---

- すべて設定するとこんな感じです
- 設定が完了したら "SAVE" をクリックして、設定内容を保存しておきます

![bg right h:600px](images/2022-11-23-16-30-42.png)

---

##### 画面表示の準備

- Bubble の API 連携の準備が出来たので、いよいよ画面の設定をしていきます
- 画面の設定は前回と今回の講義でマスターしていると思いますので、概要だけお伝えして画面レイアウトを組み立ててみてください

---

- pet_list ページを clone する形で "video_list" 画面を作成
- Repeating Group の各セルの中身を全て削除
- 代わりに Visual elements の Video をセル内いっぱいになるよう設置
- こんな感じですね

![bg right w:400](images/2024-11-22-04-06-46.png)

---

- レイアウトが出来たので実際に YouTube の一覧表示を設定していきます
- まず Repeating Group の Type of content は、先ほど API 実行時に確認した `search item` 型となります
- これで繰り返しするデータの種類が YouTube の動画 1 つ 1 つとなります

![bg right h:600px](images/2022-11-23-16-38-00.png)

---

- 次に Data source ですが、今回は API から取得した YouTube の動画一覧を対象とします
- Click から候補を見てみると `Get data from an external API` という項目があると思うのでそちらを選択

![bg right h:600px](images/2022-11-23-16-39-26.png)

---

- 隣に Get data from an external API のポップアップが表示されるので、API provider のプルダウンを選んでください
- すると、プルダウンの中に先ほど設定した `YouTube - search` の候補があると思いますのでそれを選択してください
  - ハイフンの前が API のグループ名で、後ろが具体的な API の名前です

![w:500px](images/2022-11-23-16-41-01.png)

---

- API Provider が設定できたら、CLOSE で閉じます
- そして元の Repeating Group の Data source の選択として、さらに `'s items` を選択します
- これで、API の結果に含まれる動画一覧（items）を繰り返し表示する、という指定ができました

![bg right w:600px](images/2022-11-23-16-43-51.png)

---

- 次に各セルの設定をしていきますが、まずは皆さん設定してみましょう

- Hint :bulb:
  - Video source は YouTube
  - すると Video ID という項目が表示されるので、先ほど API 設定をしたときにみた `Video Id` を参照すればよさそうですね

![bg right h:380px](images/2021-11-25-21-21-57.png)

---

- こんな感じですね

![bg right h:400px](images/2021-11-25-21-22-21.png)

---

- これで設定完了です！さっそくプレビューしてみましょう！
- 事前に API で指定したキーワードの動画一覧が表示されましたか？

---

![w:1100px](images/2022-11-23-16-53-19.png)

---

#### ＜ Advanced ＞

## Google アカウントを使ったソーシャルログイン

---

#### ＜ Advanced ＞

##### Google ログインを試してみよう

- 続いて Bubble アプリへのログインを Google アカウントを使ってログインしてみましょう！
- まずは Google のプラグインをインストール

![bg right h:500px](images/2021-11-25-17-18-29.png)

---

#### ＜ Advanced ＞

- インストールした Google プラグインを選択
- 右パネルに表示されている `Use a generic redirect URL` の欄にチェックを入れる
  - この URL もメモしておくのですが、画面上で選択ができないため、下記 URL のアプリ名部分だけご自身のアプリ名に読み替えてメモしておいてください 😅
  - `https://{Your App Name}.bubbleapps.io/api/1.1/oauth_redirect`

---

![w:1150px](images/2021-11-25-21-35-23.png)

---

#### ＜ Advanced ＞

## OAuth とは何か

OAuth はインターネット上で、あるサービスが別のサービスにパスワードを明かすことなく、認証とリソースアクセスを可能にするための仕組みになります。あなたが他のサービス（例えばペット管理サービス）を使いたいけど、そのために新しいアカウントを作りたくないとき、OAuth を使って既存のアカウント（例えば Google や Facebook のアカウント）でログインできます。

---

#### ＜ Advanced ＞

## どうやって動くのか

- ログインのリクエスト: ペット管理サービスに「Google アカウントでログイン」を選ぶ。
- 許可の確認: Google が「このサービスにあなたの情報の一部を使ってもいいか」と尋ねる。
- 「鍵」の渡し: 許可すると、Google はそのサービスに特別な「鍵」を渡す。すると、そのサービスはあなたの名前やメールアドレスなど、限られた情報にアクセスできるようになります。

![bg right h:400px](images/2023-11-10-12-00-51.png)

---

#### ＜ Advanced ＞

##### Google へのログイン後にアプリに戻ってくるための認証準備

- Google Cloud Platform 画面にアクセス

https://console.developers.google.com/

- 先程と同じ API とサービスの画面を表示

---

#### ＜ Advanced ＞

- プロジェクトを選択し、左メニューから "OAuth 同意画面" を選択

![w:800px](images/2022-11-23-17-01-25.png)

---

#### ＜ Advanced ＞

- User Type に "外部" を選択して作成をクリック

![w:700px](images/2022-11-23-17-02-41.png)

- 次ページで必要事項を入力していきます

---

#### ＜ Advanced ＞

- アプリ情報
  - アプリ名: bubble で作成したアプリ名
  - ユーザーサポートメール: ご自身の Google アカウントのメールアドレス

![bg right h:500px](images/2022-11-23-17-05-41.png)

---

#### ＜ Advanced ＞

- 承認済みドメイン
  - bubbleapps.io
- デベロッパーの連絡先情報
  - ご自身の Google アカウントのメールアドレス
- "保存して次へ"

![bg right h:450px](images/2022-11-23-17-06-31.png)

---

#### ＜ Advanced ＞

- スコープは特に設定変更せず "保存して次へ"

---

#### ＜ Advanced ＞

- テストユーザにはご自身の Google メールアドレスを入力しておく
- 設定したら保存して次へ

![bg right h:500px](images/2022-11-23-17-07-47.png)

---

#### ＜ Advanced ＞

- これで登録は完了したので続いて認証情報を発行します
- 左メニューから認証情報を選択して、「＋ 認証情報を作成」をクリック
- サブメニューから OAuth クライアント ID を選択

![w:1000px](images/2022-11-23-17-08-58.png)

---

#### ＜ Advanced ＞

- OAuth クライアント ID の作成画面が表示されるので下記の通り入力し「保存」
  - アプリケーションの種類: ウェブアプリケーション
  - 名前: `Bubble OAuth`

![bg right h:700px](images/2022-11-23-17-11-46.png)

---

#### ＜ Advanced ＞

- 承認済みのリダイレクト URI: Bubble 側で Google プラグインインストール時に控えた URL
  `https://{Your App Name}.bubbleapps.io/api/1.1/oauth_redirect`

![bg right h:700px](images/2022-11-23-17-11-46.png)

---

#### ＜ Advanced ＞

- "作成" クリック
- すると「OAuth クライアントを作成しました」というポップアップが表示され、そこにクライアント ID とクライアントシークレットが表示されているので、それをメモしておく
  - メモだと忘れるかもしれない場合は JSON をダウンロードしても OK
- メモしたら OK でクローズ

![bg right h:500px](images/2022-11-23-17-12-41.png)

---

#### ＜ Advanced ＞

##### 発行した認証情報を Bubble 側に設定

- Bubble の Google プラグイン画面に戻り、先ほど取得したキーをそれぞれの項目へ入力する
  - クライアント ID → AppID/API Key
  - クライアントシークレット → App Secret

![bg right h:370px](images/2021-11-25-17-44-20.png)

---

#### ＜ Advanced ＞

- これで事前設定は完了
- 続いてログイン機能を作り込んでいきます

---

#### ＜ Advanced ＞

##### ログイン機構を Google に置き換える

- index 画面を開き、サインアップのテキストボックスやボタンをすべて削除しましょう
- 新たにボタンを置いて、`Login by Google`といったラベルに変更しましょう

![bg right h:400px](images/2023-11-09-13-10-53.png)

---

#### ＜ Advanced ＞

- 設置したボタンの設定ウィンドウで`Edit workflow`をクリックして、ボタンクリック時のワークフロー作成を開始しましょう

![bg right h:400px](images/2023-11-09-13-13-14.png)

---

#### ＜ Advanced ＞

- Google ログインのワークフローを設定していきます
- Click here to add an action... を選択
- Account から Signup/login with a soccial network を選択

![bg right h:600px](images/2021-11-25-18-12-11.png)

---

#### ＜ Advanced ＞

- Signup/login with Google のポップアップが表示されます
- OAuth provider に Google を選択

![bg right h:350px](images/2021-11-25-18-14-22.png)

---

#### ＜ Advanced ＞

ログインができた後に、ペットリストに遷移するように指定しましょう

- Click here to add an action... を選択
- `Navigation`>`Go to page`を指定する
- Destination に`pet_list`を指定する

これだけで Google アカウントでのログインができるようになりました。簡単ですね。

---

#### ＜ Advanced ＞

- 折角なのでログイン成功したらヘッダー上部にアカウント名と画像を表示してみましょう

![w:500px](images/2024-11-22-04-45-20.png)

---

#### ＜ Advanced ＞

- Reusable elements の header を開きます

![w:900px](images/2022-11-23-17-16-03.png)

---

#### ＜ Advanced ＞

- Design タブに切り替え、現在非表示になっている Log
  out ボタンのコンポーネントを Elements tree から表示しておきます
  - こうしておかないと、画像追加後のイメージが分かりづらいため

![bg right w:600](images/2024-11-22-04-30-36.png)

---

#### ＜ Advanced ＞

- Visual elements から Image を選択し、"Log out" ボタンの左に画像を配置します
  - 縦横 50 x 50 の正方形にしておきましょう

![w:900](images/2024-11-22-04-32-51.png)

---

#### ＜ Advanced ＞

- そして、画像の参照元を設定します
- Bubbler の皆さんなら設定方法はイメージつきますよね
- 動的な表示設定は Dynamic image
- 表示したいのは現在ログインしているユーザの Google アカウントのプロフィール画像

---

#### ＜ Advanced ＞

- こんな感じですね

![bg right h:450px](images/2021-11-25-18-36-17.png)

---

#### ＜ Advanced ＞

- ではプレビューしてみましょう！
  - 事前に Data の User にこれから動作確認する際に使用する Google メールアドレスと同じメールアドレスのデータがある場合は削除しておいてください
- ログインボタンを押すと Google のログイン画面に遷移し、そこでログインをすると Bubble 側に戻ってきましたよね？
- ちなみに、ログインすると Bubble 側の User data にログインした Google アカウントのメールアドレス情報が登録されます
  - もちろんパスワードは保存されていないのでご安心を :smile:

![w:500px](images/2024-11-22-04-45-20.png)

---

#### ＜ Advanced ＞

# YouTube の動画一覧を動的に検索

![w:700px](images/2022-11-23-17-57-09.png)

---

#### ＜ Advanced ＞

- 現状では YouTube API の認証キーや検索キーワードは固定になっています
- なので、これを下記のように変えてみましょう
  - 認証キーはログインしているユーザ情報から取得する（新たに field を追加する）
  - 検索キーワードは画面から入力・検索できるようにする

---

#### ＜ Advanced ＞

次のページにヒントを書いておきますのでまずはトライしてみましょう！

---

#### ＜ Advanced ＞

- まずは User に対して `key` という field を追加し、事前に設定しておく
  - 本来ここもユーザ自身に入力させるなどの導線が自然ですが今回は時間の都合上、API キーの設定画面は割愛します
- API のパラメータを処理の中で動的に設定する場合、まずは固定値を無くし `Private` のチェックを外すことで、DataSource などで API 呼び出しする際にパラメータを指定できます
- video_list ページに新たに検索用の要素（テキストボックスと検索ボタン）を配置し、検索ボタンがクリックされた時に、YouTube API 経由で検索を行い、結果を Repeating Group にセットしてあげます

---

# :hourglass_flowing_sand:

# :hourglass_flowing_sand:

# :hourglass_flowing_sand:

# :hourglass:

# :hourglass:

---

#### ＜ Advanced ＞

- 重要なポイントを解説します
- まずは User の型に対して `key` という field を追加します

![](images/2021-11-25-22-32-01.png)

---

#### ＜ Advanced ＞

- そして、今回取得した認証キー（API キー）を登録済みの User に事前にセットしておきます

![](images/2021-11-25-22-32-29.png)

---

#### ＜ Advanced ＞

- 次に YouTube API 側の設定はこんな感じですね

![bg right h:400px](images/2021-11-25-22-19-37.png)

---

#### ＜ Advanced ＞

- ポイントとしては、動的に指定したい項目については Value の値を削除し、Private のチェックを外しました
- これにより、API を使う場面でこれらのパラメータの値を指定することができるようになります

![bg right h:400px](images/2021-11-25-22-19-37.png)

---

#### ＜ Advanced ＞

- ついでに、検索のオプションを 2 つ追加しておきましょう
- key: `maxResults`、1 回の検索で取得するデータの件数
  - デフォルトは 5
- key: `type`、検索対象のデータ種類
  - `video` を指定することで、動画だけの検索が可能

![bg right h:400px](images/2022-11-23-17-48-22.png)

---

#### ＜ Advanced ＞

- 続いて Repeating Group の Data source を空にします
- 表示する対象データの指定は、新たに設ける検索機能のワークフローの中で設定するため、ここが空でも問題ありません

![bg right h:500px](images/2021-11-25-22-21-24.png)

---

#### ＜ Advanced ＞

- 次にキーワード検索が行われた時のワークフローの設定となるため、新たに用意した検索ボタンに対してワークフローを設定します
- 今回は要素（Repeating Group）に対するアクションとなるため "Element Actions" の中にある "Display list" を選択します

![bg right h:600px](images/2021-11-25-22-27-04.png)

---

#### ＜ Advanced ＞

- Data source には Get data from an external API を選択し、API 経由のデータ表示とします
- そして API provicer に `YouTube - search` を選択すると、先ほどはなかった 2 つの param が表示されるはずです
- これは先ほど YouTube API 側の設定で動的に指定したいパラメータについて Private のチェックを外したためとなります
- ここで指定する値はいつもの Dynamic data ですね

---

#### ＜ Advanced ＞

- 設定するとこんな感じです

![w:1100px](images/2022-11-23-17-55-08.png)

---

#### ＜ Advanced ＞

#### プレビューしてみましょう

- ログインしている状態で、キーワード欄に入力した動画一覧が表示されましたか？

![w:600px](images/2022-11-23-17-57-09.png)

---

#### ＜ Advanced ＞

- いかがでしたでしょうか？
- API 連携を行うことで、Bubble で出来る幅がさらに広がったと思います！
- 合宿でも外部の API を使うチームがあるかもしれませんが、そのときは今日学んだことを活かして、API 連携を実践してみましょう！

---

## チームで開発する

---

## Bubble での共同作業の Tips

チームで Bubble を使って共同作業をする時に役立つ情報をお伝えします。

---

#### Bubble でのチームメンバーの招待方法

チームメンバーと一つのアプリを共同編集するには...

- チームで一つのアカウントを用意し、そのアカウントをみんなでログインして使いまわすことになります

---

- Bubble には正規の方法による共同編集機能はついているのですが... 💰💰💰

![h:450px](images/2023-11-09-13-45-53.png)

---

#### Bubble での同時編集の注意点

- 同じエレメントに対する同時編集は避けましょう(後から行われた編集で上書きされます)
  - そのためには、画面ごとに担当者を決めて同じ画面の同時編集を避けるのがおすすめです。
- それ以外の注意点は特にありません。
- 編集は他の人の画面にリアルタイムで反映されます。
  - 画面の編集だけでなく、データベースや Workflow の編集もリアルタイムで反映されます。
- 画面ごとに作業分担すれば、難なく開発できそうです。

---

## チーム開発演習

- DevelopmentPhase のチームで、新たに一つアプリを開発してみてください
  - DevelopmentPhase で開発予定のアプリとは異なるアプリにしましょう
- 全員が手を動かすようにしましょう

---

#### 作業分担のやり方の例

- 画面や機能の洗い出しとデータベース設計は最初にみんなで一緒にやりましょう
- 画面ごとに担当者を決めましょう(登録画面担当、一覧画面担当、詳細画面担当、更新画面担当 など)
- 複数人で一つの PC を使って作業をするというやり方もあります。その場合、PC 操作をする人と指示をする人は定期的に交代しましょう

---

# :hourglass_flowing_sand:

# :hourglass_flowing_sand:

# :hourglass_flowing_sand:

# :hourglass:

# :hourglass:

---

#### 演習結果の発表

チームごとに演習で作ったアプリについて発表してみましょう！

---

本日のレクチャーは以上になります。

---

### 最後に

- Google Cloud Platform で発行した API キーや OAuth の情報を削除しておきましょう

---

# 以上です！

# お疲れさまでした！
